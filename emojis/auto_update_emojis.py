import os
import random
import re

# 安卓系统主流支持的 Emoji 列表（Unicode 13.0+，广泛兼容，欢迎自行补充扩展）
ANDROID_SUPPORTED_EMOJIS = [
    # 表情符号
    "😀","😁","😂","🤣","😃","😄","😅","😆","😉","😊","😋","😎","😍","😘","🥰","😗","😙","😚",
    "🙂","🤗","🤩","🤔","🤨","😐","😑","😶","🙄","😏","😣","😥","😮","🤐","😯","😪","😫",
    "🥱","😴","😌","😛","😜","😝","🤤","😒","😓","😔","😕","🙃","🤑","😲","☹️","🙁","😖",
    "😞","😟","😤","😢","😭","😦","😧","😨","😩","🤯","😬","😰","😱","🥵","🥶","😳","🤪",
    "😵","😡","😠","🤬","😷","🤒","🤕","🤢","🤮","🤧","😇","🥳","🥺","🥲","🤠","🥸","🤓",
    "🧐","🫠","🤖","👻","💀","☠️","👽","👾","👹","👺","💩","😺","😸","😹","😻","😼","😽",
    "🙀","😿","😾","🙈","🙉","🙊",
    # 天气与自然
    "🌞","🌝","🌚","🌕","🌖","🌗","🌘","🌑","🌒","🌓","🌔","🌙","🌎","🌍","🌏","🪐","⭐","🌟",
    "✨","⚡","☄️","💥","🔥","🌪️","🌈","☀️","🌤️","⛅","🌥️","☁️","🌦️","🌧️","⛈️","🌩️","🌨️",
    "❄️","☃️","⛄","🌬️","💨","💧","💦","☔","☂️","🌊","🌫️",
    # 动物与自然
    "🐶","🐱","🐭","🐹","🐰","🦊","🐻","🐼","🐨","🐯","🦁","🐮","🐷","🐽","🐸","🐵","🙈","🙉","🙊",
    "🐒","🐔","🐧","🐦","🐤","🐣","🐥","🦆","🦅","🦉","🦇","🐺","🐗","🐴","🦄","🐝","🐛","🦋",
    "🐌","🐚","🐞","🐜","🦗","🕷️","🦂","🐢","🐍","🦎","🦖","🦕","🐙","🦑","🦐","🦞","🦀","🐡",
    "🐠","🐟","🐬","🐳","🐋","🦈","🐊","🐅","🐆","🐘","🦏","🦛","🐪","🐫","🦙","🦒","🐃","🐂",
    "🐄","🐎","🐖","🐏","🐑","🐐","🦌","🐕","🐩","🦮","🐕‍🦺","🐈","🐓","🦃","🦚","🦜","🦢",
    "🦩","🕊️","🐇","🦝","🦨","🦡","🦦","🦥","🐁","🐀","🐿️","🦔",
    # 食物与饮料
    "🍏","🍎","🍐","🍊","🍋","🍌","🍉","🍇","🍓","🫐","🍈","🍒","🍑","🥭","🍍","🥥","🥝",
    "🍅","🍆","🥑","🥦","🥬","🥒","🌶️","🫑","🌽","🥕","🫒","🧄","🧅","🥔","🍠","🥐","🥯",
    "🍞","🥖","🥨","🧀","🥚","🍳","🥞","🧇","🥓","🥩","🍗","🍖","🦴","🌭","🍔","🍟","🍕",
    "🥪","🥙","🧆","🌮","🌯","🫔","🥗","🥘","🫕","🍝","🍜","🍲","🍛","🍣","🍱","🥟","🦪",
    "🍤","🍙","🍚","🍘","🍥","🥠","🥮","🍢","🍡","🍧","🍨","🍦","🥧","🧁","🍰","🎂","🍮",
    "🍭","🍬","🍫","🍿","🍩","🍪","🥛","🍼","☕","🫖","🍵","🧃","🥤","🧋","🍶","🍺","🍻",
    "🥂","🍷","🥃","🧉","🍸","🍹","🧊","🥄","🍴","🍽️","🥣","🥡","🥢","🧂",
    # 活动
    "⚽","🏀","🏈","⚾","🥎","🎾","🏐","🏉","🥏","🎱","🪀","🏓","🏸","🏒","🏑","🥍","🏏",
    "🪃","🥅","⛳","🪁","🏹","🎣","🤿","🥊","🥋","🎽","🛹","🛷","⛸️","🥌","🛶","⛵","🚤",
    "🛥️","🛳️","⛴️","🚢","✈️","🛩️","🚁","🚟","🚠","🚡","🚀","🛸",
    # 物品
    "⌚","📱","📲","💻","⌨️","🖥️","🖨️","🖱️","🖲️","🕹️","🗜️","💽","💾","💿","📀","📼",
    "📷","📸","📹","🎥","📽️","🎞️","📞","☎️","📟","📠","📺","📻","🎙️","🎚️","🎛️","⏱️",
    "⏲️","⏰","🕰️","⌛","⏳","📡","🔋","🔌","💡","🔦","🕯️","🧯","🛢️","💸","💵","💴",
    "💶","💷","🪙","💰","💳","🧾","💎","⚖️","🪜","🧰","🪛","🔧","🔨","⚒️","🛠️","⛏️",
    "🔩","⚙️","🗜️","⚗️","🧪","🧫","🧬","🔬","🔭","📡","💉","💊","🩹","🩺","🚪","🛏️",
    "🛋️","🪑","🚽","🚿","🛁","🪞","🪟","🧴","🧷","🧹","🧺","🧻","🪠","🚬","⚰️","🪦","⚱️",
    "🗿","🪧","🪪",
    # 交通
    "🚗","🚕","🚙","🚌","🚎","🏎️","🚓","🚑","🚒","🚐","🛻","🚚","🚛","🚜","🦽","🦼","🛴",
    "🚲","🛵","🏍️","🛺","🚨","🚔","🚍","🚘","🚖","🚡","🚠","🚟","🚃","🚋","🚞","🚝","🚄",
    "🚅","🚈","🚂","🚆","🚇","🚊","🚉","✈️","🛫","🛬","🛩️","💺","🛰️","🚀","🛸","🚁","🛶",
    # 旗帜（取部分常用的，安卓全面支持）
    "🏳️","🏴","🏁","🚩","🏳️‍🌈","🏳️‍⚧️","🇨🇳","🇺🇸","🇬🇧","🇫🇷","🇯🇵","🇰🇷","🇩🇪","🇷🇺",
    "🇮🇳","🇮🇩","🇧🇷","🇦🇺","🇨🇦","🇸🇬","🇹🇼","🇭🇰","🇹🇭","🇮🇹","🇪🇸","🇲🇽","🇸🇪","🇳🇱",
    "🇹🇷","🇸🇦","🇦🇪","🇨🇭","🇳🇿","🇲🇾","🇳🇴","🇩🇰","🇫🇮","🇵🇹","🇵🇱","🇧🇪","🇦🇷","🇿🇦",
    "🇪🇬"
]

# 替换用的 emoji 集合
REPLACEMENT_EMOJIS = ANDROID_SUPPORTED_EMOJIS.copy()

# 构造正则：匹配所有安卓主流支持的 Emoji
# 这里采用分组拼接所有 emoji 字符，保证精确匹配每一个单体 emoji
TARGET_EMOJI_PATTERN = re.compile(
    r'({})'.format('|'.join(re.escape(emoji) for emoji in ANDROID_SUPPORTED_EMOJIS))
)

def replace_android_emojis_in_line(line, used_emojis):
    """
    替换一行中所有安卓支持的 emoji（每个新 emoji 全局不重复，直到用尽），其他内容不变。
    """
    def emoji_replacer(match):
        available = list(set(REPLACEMENT_EMOJIS) - used_emojis)
        if not available:
            available = REPLACEMENT_EMOJIS  # 用尽后允许重复
        chosen = random.choice(available)
        used_emojis.add(chosen)
        return chosen
    return TARGET_EMOJI_PATTERN.sub(emoji_replacer, line)

def process_file(input_path, output_path):
    """
    逐行处理文件：只替换安卓支持的 emoji，其他内容（字母/数字/标点/缩进/换行/中文等）全部保留
    """
    try:
        with open(input_path, 'r', encoding='utf-8') as f:
            lines = f.readlines()
    except Exception as e:
        print(f"读取文件失败: {input_path}, 错误: {e}")
        return
    used_emojis = set()
    processed_lines = []
    for line in lines:
        replaced_line = replace_android_emojis_in_line(line, used_emojis)
        processed_lines.append(replaced_line)
    try:
        with open(output_path, 'w', encoding='utf-8') as f:
            f.writelines(processed_lines)
        print(f"已生成文件: {output_path}")
    except Exception as e:
        print(f"写入文件失败: {output_path}, 错误: {e}")

def main():
    """
    默认处理 emojis 目录下所有 .json 文件，结果保存在 emojis/output/ 下，文件名保持一致
    """
    script_dir = os.path.dirname(os.path.abspath(__file__))
    emojis_dir = script_dir
    output_dir = os.path.join(emojis_dir, "output")
    os.makedirs(output_dir, exist_ok=True)
    for file in os.listdir(emojis_dir):
        if file.endswith('.json'):
            input_path = os.path.join(emojis_dir, file)
            output_path = os.path.join(output_dir, file)
            process_file(input_path, output_path)

if __name__ == "__main__":
    main()
